<?php

/**
 * Yoti tests.
 */
class YotiTest extends DrupalWebTestCase {

  /**
   * Check that an element exists in HTML markup.
   *
   * @param string $xpath
   *   An XPath expression.
   * @param array $arguments
   *   (optional) An associative array of XPath replacement tokens to pass to
   *   DrupalWebTestCase::buildXPathQuery().
   * @param string $message
   *   (optional) The message to display along with the assertion.
   * @param string $html
   *   (optional) HTML to check.
   * @param string $group
   *   (optional) The type of assertion - examples are "Browser", "PHP".
   *
   * @return bool
   *   TRUE if the assertion succeeded, FALSE otherwise.
   */
  protected function assertElementByXpath($xpath, array $arguments = array(), $message = '', $html = NULL, $group = 'Other') {
    if (!empty($html)) {
      $domXpath = new DOMXPath(filter_dom_load($html));
      $expression = $this->buildXPathQuery($xpath, $arguments);
      $result = $domXpath->query($expression);
    }
    else {
      $result = $this->xpath($xpath, $arguments);
    }
    return $this->assertTrue(!empty($result[0]), $message, $group);
  }

  /**
   * Modules to enable.
   *
   * @var array
   */
  public $modules = array(
    'block',
    'node',
    'yoti',
  );

  /**
   * A user with the 'administer yoti' permission.
   *
   * @var object
   */
  private $adminUser;

  /**
   * Selfie file path.
   *
   * @var string
   */
  private $selfieFilePath;

  /**
   * Yoti test config.
   *
   * @var array
   */
  private $yotiConfig = array(
    'yoti_app_id' => 'test_yoti_app_id',
    'yoti_scenario_id' => 'test_yoti_scenario_id',
    'yoti_sdk_id' => 'test_yoti_sdk_id',
    'yoti_company_name' => 'test_yoti_company_name',
    'yoti_age_verification' => 'test_yoti_age_verification',
    'yoti_only_existing' => FALSE,
    'yoti_success_url' => 'test_yoti_success_url',
    'yoti_fail_url' => 'test_yoti_fail_url',
    'yoti_user_email' => 'test_yoti_user_email',
    'yoti_pem' => 'pem_contents',
  );

  /**
   * Info.
   *
   * @return array
   *   The test info
   */
  public static function getInfo() {
    return array(
      'name' => 'Yoti',
      'description' => 'Test Yoti.',
      'group' => 'Yoti',
    );
  }

  /**
   * Setup.
   */
  public function setUp() {
    parent::setUp($this->modules);

    // Create admin user.
    $this->adminUser = $this->drupalCreateUser(array(
      'access administration pages',
      'administer yoti',
      'administer blocks',
      'administer modules',
      'administer site configuration',
    ));

    // Configure module.
    $this->configureModule();

    // Enable block caching.
    variable_set('block_cache', TRUE);

    // Create secure file directory.
    if (!is_dir(YotiHelper::secureUploadDir())) {
      mkdir(YotiHelper::secureUploadDir(), 0777, TRUE);
    }

    // Create test selfie file.
    $this->selfieFilePath = YotiHelper::secureUploadDir() . DIRECTORY_SEPARATOR . 'test_selfie.jpg';
    file_put_contents($this->selfieFilePath, 'test_selfie_contents');

    // Create a linked user.
    $this->linkedUser = $this->drupalCreateUser();
    $this->linkUser($this->linkedUser->uid);

    // Create an unlinked user.
    $this->unlinkedUser = $this->drupalCreateUser();
  }

  /**
   * Clean up test data.
   */
  public function teardown() {
    // Remove test file.
    clearstatcache(NULL, $this->selfieFilePath);
    if (is_file($this->selfieFilePath)) {
      unlink($this->selfieFilePath);
    }

    // Remove test directory.
    if (is_dir(YotiHelper::secureUploadDir())) {
      rmdir(YotiHelper::secureUploadDir());
    }

    parent::teardown();
  }

  /**
   * Links provided user.
   */
  private function linkUser($uid) {
    db_insert(YotiHelper::YOTI_USER_TABLE_NAME)->fields([
      'uid' => $uid,
      'identifier' => 'some-remember-me-id',
      'data' => serialize(array(
        'full_name' => 'test full name',
        'selfie_filename' => $this->selfieFilePath,
      )),
    ])->execute();
  }

  /**
   * Configure module.
   */
  private function configureModule() {
    foreach ($this->yotiConfig as $key => $value) {
      variable_set($key, $value);
    }

    // Create a test pem file.
    $pem_file = file_save_data($this->yotiConfig['yoti_pem'], 'private://yoti_test.pem', FILE_EXISTS_REPLACE);
    variable_set('yoti_pem', $pem_file->fid);
  }

  /**
   * Delete configuration.
   */
  private function deleteModuleConfiguration() {
    foreach (array_keys($this->yotiConfig) as $key) {
      variable_del($key);
    }
  }

  /**
   * Test Yoti block.
   */
  public function testBlock() {
    $this->drupalLogin($this->adminUser);

    // Place the block in the content region.
    $edit = array(
      'regions[bartik]' => 'content',
      'regions[seven]' => 'content',
    );
    $this->drupalPost('admin/structure/block/manage/yoti/yoti_link/configure', $edit, t('Save block'));

    // Check that the block is present with the correct configuration.
    $this->drupalGet('<front>');

    $this->assertElementByXpath(
      '//div[@class=:class]/div[@id=:id]',
      array(
        ':id' => 'yoti-button-yoti_link',
        ':class' => 'yoti-connect',
      ),
      'Check button markup is correct.'
    );

    // Check JSON config is present.
    $config = array(
      'elements' => array(
        array(
          'domId' => 'yoti-button-yoti_link',
          'clientSdkId' => 'test_yoti_sdk_id',
          'scenarioId' => 'test_yoti_scenario_id',
          'button' => array(
            'label' => 'Link to Yoti',
          ),
        ),
      ),
    );
    $this->assertRaw(
      json_encode($config),
      'Check button configuration is correct'
    );

    // Check that SDK script is included on page.
    $this->assertElementByXpath(
      '//head/script[@src=:base_url]',
      array(
        ':base_url' => 'https://www.yoti.com/share/client/',
      ),
      'Check SDK browser JS is present.'
    );

    // Check that button CSS is included on page.
    $this->assertRaw('/yoti/css/yoti.css');

    // Check that SDK script is included on page.
    $this->assertElementByXpath(
      '//body//script[contains(text(),:script)]',
      array(
        ':script' => 'window.Yoti.Share.init(Drupal.settings.yoti);',
      ),
      'Check SDK inline init script is present.'
    );

    // Check that linked users see linked message.
    $this->drupalLogin($this->linkedUser);
    $this->drupalGet('<front>');
    $this->assertText('Yoti Linked');

    // Check that unlinked users don't see linked message.
    $this->drupalLogin($this->unlinkedUser);
    $this->drupalGet('<front>');
    $this->assertRaw('Link to Yoti');
    $this->assertNoText('Yoti Linked');
  }

  /**
   * Test link menu item for linked users.
   */
  public function testLinkForLinkedUsers() {
    $this->drupalLogin($this->linkedUser);
    $this->drupalGet('yoti/link');
    $this->assertResponse(403);
    $this->assertText('Access denied');
  }

  /**
   * Test link menu item for unlinked users.
   */
  public function testLinkForUnlinkedUsers() {
    $this->drupalLogin($this->unlinkedUser);

    $this->drupalGet('yoti/link', array('query' => array('token' => '')));
    $this->assertText('Could not get Yoti token.');

    $this->drupalGet('yoti/link', array('query' => array('token' => 'some-invalid-token')));
    $this->assertText('Yoti could not successfully connect to your account.');
  }

  /**
   * Test Unlink Form.
   */
  public function testUnlinkForm() {
    // Log in as linked user.
    $this->drupalLogin($this->linkedUser);

    // Visit user profile.
    $this->drupalGet('user');

    $this->assertElementByXpath(
      "//div[contains(@class,:wrapper_class)]//a[@href=:href][@id=:id]",
      array(
        ':wrapper_class' => 'yoti-connect',
        ':href' => '/yoti/unlink',
        ':id' => 'yoti-unlink-button',
        ':class' => 'button',
      ),
      'Check unlink Yoti Account link'
    );

    $this->clickLink('Unlink Yoti Account');
    $this->assertElementByXpath(
      "//h1[contains(text(),:text)]",
      array(
        ':text' => 'Unlink Yoti Account',
      ),
      'Check Unlink Yoti Account title'
    );
    $this->assertText('Are you sure you want to unlink your account from Yoti?');
    $this->drupalPost('yoti/unlink', array(), t('Yes'));
    $this->assertUrl('/');

    // Check account was unlinked.
    $this->drupalGet('user');
    $this->assertNoText('Unlink Yoti Account');

    // Check selfie was removed.
    clearstatcache(NULL, $this->selfieFilePath);
    $this->assertFalse(is_file($this->selfieFilePath), 'Check selfie has been deleted');
  }

  /**
   * Test user profile permissions.
   */
  public function testProfilePermissions() {
    // Log in as unlinked user.
    $this->drupalLogin($this->unlinkedUser);

    // Check selfie exists and cannot be viewed by another user.
    $this->assertTrue(is_file($this->selfieFilePath), 'Check selfie exists');
    $this->drupalGet('yoti/bin-file', array(
      'query' => array(
        'field' => YotiHelper::YOTI_BIN_FIELD_SELFIE,
        'user_id' => $this->linkedUser->uid,
      ),
    ));
    $this->assertNoRaw('test_selfie_contents');
    $this->assertResponse(404);

    // Log in as user with access to view user profiles and selfies.
    $userWithUserProfilesAndSelfiePermission = $this->drupalCreateUser(array(
      'access user profiles',
      YotiHelper::YOTI_PERMISSION_VIEW_SELFIE,
    ));
    $this->drupalLogin($userWithUserProfilesAndSelfiePermission);
    $this->drupalGet('user/' . $this->linkedUser->uid);
    $this->assertProfileSelfieCanBeViewed();

    // Log in as user with access to view user profiles.
    $userWithUserProfilesPermission = $this->drupalCreateUser(array(
      'access user profiles',
    ));
    $this->linkUser($userWithUserProfilesPermission->uid);
    $this->drupalLogin($userWithUserProfilesPermission);
    $this->drupalGet('user/' . $this->linkedUser->uid);
    $this->assertNoRaw('yoti/bin-file');

    // Check user without selfie permission cannot see other selfie images.
    $this->drupalGet('user');
    $url = $this->getSelfieUrl();
    $url['query']['user_id'] = $this->linkedUser->uid;
    $this->drupalGet(trim($url['path'], '/'), array('query' => $url['query']));
    $this->assertNoRaw('test_selfie_contents');
    $this->assertResponse(403);
  }

  /**
   * Test user profile display.
   */
  public function testProfileDisplay() {
    // Log in as linked user.
    $this->drupalLogin($this->linkedUser);

    // Visit user profile.
    $this->drupalGet('user');

    // Check full name is present.
    $this->assertText('test full name');

    // Check all attributes are present.
    $attribute_ids = array(
      'yoti-profile-selfie',
      'yoti-profile-full_name',
      'yoti-profile-given_names',
      'yoti-profile-family_name',
      'yoti-profile-phone_number',
      'yoti-profile-email_address',
      'yoti-profile-date_of_birth',
      'yoti-profile-age_verified',
      'yoti-profile-postal_address',
      'yoti-profile-gender',
      'yoti-profile-nationality',
    );
    foreach ($attribute_ids as $attribute_id) {
      $this->assertElementByXpath(
        '//div[@id=:id]',
        array(':id' => $attribute_id),
        sprintf('Check #%s element exists', $attribute_id));
    }

    $this->assertProfileSelfieCanBeViewed();
  }

  /**
   * Test Yoti Requirements.
   */
  public function testRequirements() {
    $this->drupalLogin($this->adminUser);
    $this->drupalGet('admin/reports/status');
    $this->assertNoText('Yoti Configuration');

    $this->deleteModuleConfiguration();
    $this->drupalGet('admin/reports/status');
    $this->assertText('Yoti Configuration');
    $this->assertText('Not Configured');
    $this->assertText('Please configure the following:');
    $this->assertText('Application ID (yoti_app_id)');
    $this->assertText('Scenario ID (yoti_scenario_id)');
    $this->assertText('Client SDK ID (yoti_sdk_id)');
    $this->assertText('PEM File (yoti_pem)');
  }

  /**
   * Test Register Form.
   */
  public function testRegisterForm() {
    module_load_include('inc', 'yoti', 'yoti.pages');

    // Set session data.
    $_SESSION['yoti-user'] = serialize('test_user_data');

    // Render form.
    $form = drupal_get_form('yoti_register');
    $form_markup = drupal_render($form);

    $this->assertElementByXpath(
      "//form//div[contains(@class,:class)]//input[@name=:name][@type=:type]",
      array(
        ':class' => 'yoti-login-message',
        ':name' => 'yoti_nolink',
        ':type' => 'checkbox',
      ),
      '"No link" checkbox exists',
      $form_markup
    );

    $this->assertElementByXpath(
      '//form//div[contains(@class,:class)]//label[@for=:id][contains(text(),:text)]',
      array(
        ':class' => 'yoti-login-message',
        ':id' => 'edit-yoti-nolink',
        ':text' => "Don't link my Yoti account",
      ),
      '"No link" checkbox label',
      $form_markup
    );

    $messages = array(
      'Warning: You are about to link your test_yoti_company_name account to your Yoti account.',
      "If you don't want this to happen, tick the checkbox below.",
    );
    $this->assertElementByXpath(
      '//form//div[contains(@class,:class)]//div/b[contains(text(),:text)]',
      array(
        ':class' => 'yoti-login-message',
        ':text' => implode(' ', $messages),
      ),
      'Check login message',
      $form_markup
    );

    $this->assertElementByXpath(
      '//form//label[@for=:id][contains(text(),:text)]',
      array(
        ':id' => 'edit-name',
        ':text' => "Your test_yoti_company_name Username",
      ),
      'Check username label',
      $form_markup
    );

    $this->assertElementByXpath(
      '//form//label[@for=:id][contains(text(),:text)]',
      array(
        ':id' => 'edit-pass',
        ':text' => "Your test_yoti_company_name Password",
      ),
      'Check password label',
      $form_markup
    );

    $this->assertTrue(
      strstr($form['#attached']['css'][0]['data'], 'yoti/css/yoti.css'),
      'Check CSS is attached to form'
    );
  }

  /**
   * Get selfie URL on current page.
   *
   * @return array
   *   URL consisting of `path` and `query`
   */
  private function getSelfieUrl() {
    $result = $this->xpath("//div[@id='yoti-profile-selfie']//img");
    $url_parts = parse_url((string) $result[0]['src']);
    parse_str($url_parts['query'], $query);

    return array(
      'path' => $url_parts['path'],
      'query' => $query,
    );
  }

  /**
   * Assert that the selfie on the profile can be viewed.
   */
  private function assertProfileSelfieCanBeViewed() {
    $url = $this->getSelfieUrl();
    $this->drupalGet(trim($url['path'], '/'), array('query' => $url['query']));
    $this->assertRaw('test_selfie_contents');
    $this->assertResponse(200);
  }

}
